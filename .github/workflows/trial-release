name: trail
on:
  push:
    branches:
      - develop
  pull_request:  # Use this for conflict-proofing; fallback to pull_request if needed
    types: [opened, reopened, synchronize, closed]
    branches:
      - develop
  workflow_dispatch:  # For manual testing
permissions:
  contents: write
  pull-requests: write
jobs:
  update_release_draft:
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request_target' &&
       github.event.action != 'closed')
    runs-on: ubuntu-latest
    steps:
      - uses: release-drafter/release-drafter@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Debug draft releases
        run: |
          curl -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }}/releases
  debug_pr_close:  # NEW: Always runs on closed to inspect why it skips
    if: |
      github.event_name == 'pull_request_target' &&
      github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Debug full PR event
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Merged: ${{ github.event.pull_request.merged }}"
          echo "Base branch: ${{ github.event.pull_request.base.ref }}"
          echo "Has conflicts? (manual check needed; see PR UI)"
          echo "All labels: ${{ toJSON(github.event.pull_request.labels) }}"
          echo "Has 'publish' label: ${{ contains(fromJson(toJSON(github.event.pull_request.labels)).*.name, 'publish') }}"
          echo "Full event payload snippet:"
          echo "${{ toJSON(github.event.pull_request) }}" | jq '.'  # Requires jq; assumes ubuntu-latest has it
      - name: Check branch protections
        run: |
          curl -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }}/branches/develop/protection
  publish_draft:
    needs: debug_pr_close  # Run after debug for context
    if: |
      github.event_name == 'pull_request_target' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      contains(fromJson(toJSON(github.event.pull_request.labels)).*.name, 'publish')
    runs-on: ubuntu-latest
    steps:
      # ... (keep your existing steps: checkout, debug labels, rate limit, publish script)
      # In publish script, add: console.log(`Merged: ${context.payload.pull_request.merged}`);
